<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

    <title>Raspberry Pi + PHP socket</title>
    <meta name="description"
      content="Recently I did a post about HTML5 WebSocketsand it had a purpose. I was preparing the material of mytalk at Samsung Ocean and my goal was create a RC carwith...">

    <link rel="canonical" href="https://marabesi.com/iot/2015/05/09/raspberry-pi-php-socket.html">
    <link rel="alternate" type="application/rss+xml" title="Marabesi"
      href="https://marabesi.com/feed.xml">

    <meta property="og:title" content="Raspberry Pi + PHP socket" />
    <meta property="og:site_name" content="marabesi.com" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://marabesi.com/iot/2015/05/09/raspberry-pi-php-socket.html" />
    <meta property="og:image"
      content="https://marabesi.com/images/posts/2015-05-09-raspberry-pi-php-socket/cover.jpg" />
    <meta property="og:description"
      content="Recently I did a post about HTML5 WebSocketsand it had a purpose. I was preparing the material of mytalk at Samsung Ocean and my goal was create a RC carwith..." />

    <meta property="fb:app_id" content="536384943068161" />

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@MatheusMarabesi">
    <meta name="twitter:title" content="Raspberry Pi + PHP socket">
    <meta name="twitter:description"
      content="Recently I did a post about HTML5 WebSocketsand it had a purpose. I was preparing the material of mytalk at Samsung Ocean and my goal was create a RC carwith...">
    <meta name="twitter:creator" content="@MatheusMarabesi">
    <meta name="twitter:image:src"
      content="https://marabesi.com/images/posts/2015-05-09-raspberry-pi-php-socket/cover.jpg">

    <meta name="keywords" content="apache,codepen,html5,keyboard,monitor,nginx,php,raspberry,ratchet,sockets,web,wipi,html,w3c,codepen" />

    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">

    <link href="/assets/main-bundle.css" rel="stylesheet" />

    <!-- See https://goo.gl/OOhYW5 -->
    <link rel="manifest" href="/manifest.json">

    <!-- See https://goo.gl/qRE0vM -->
    <meta name="theme-color" content="#3f51b5">

    <!-- Add to homescreen for Chrome on Android. Fallback for manifest.json -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Marabesi">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Marabesi">

    <!-- Homescreen icons -->
    <link rel="apple-touch-icon" href="/images/manifest/icon-48x48.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/images/manifest/icon-72x72.png">
    <link rel="apple-touch-icon" sizes="96x96" href="/images/manifest/icon-96x96.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/images/manifest/icon-144x144.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/images/manifest/icon-192x192.png">

    <!-- Tile icon for Windows 8 (144x144 + tile color) -->
    <meta name="msapplication-TileImage" content="/images/manifest/icon-144x144.png">
    <meta name="msapplication-TileColor" content="#3f51b5">
    <meta name="msapplication-tap-highlight" content="no">
  </head>

  <body class="font-sans overflow-x-hidden">
    <button class="update-button w-full text-white bg-marabesi-purple p-5 m-auto fixed pin-b z-50 hidden focus:outline-none font-bold">Update found, click to update</button>

    <div class="menu-wrapper flex fixed w-full bg-white z-50">
      <nav class="top-menu hidden md:flex justify-start container lg:justify-center md:m-auto md:pt-2 md:pb-2">
        <a href="/" class="hidden md:block">
          <img class="logo w-18 p-1" data-src="/images/logo.png" width="100" alt="marabesi.com logo - two m's and one dot" title="marabesi.com logo - two m's and one dot" />
        </a>

        <ul id="menu-list" class="container-menu hidden flex-col pl-5 md:flex md:pl-0 md:flex-row md:m-auto lg:m-0">
          
           
            <li class="item pt-2 pb-2 md:p-2">
              <a class="item-link no-underline" href="/talks">
                Talks
              </a>
            </li>
          
          
           
            <li class="item pt-2 pb-2 md:p-2">
              <a class="item-link no-underline" href="/about">
                About
              </a>
            </li>
          
          
           
            <li class="item pt-2 pb-2 md:p-2">
              <a class="item-link no-underline" href="/newbie-guide">
                Dev guide
              </a>
            </li>
          
          
           
            <li class="item pt-2 pb-2 md:p-2">
              <a class="item-link no-underline" href="/resources">
                software development
              </a>
            </li>
          
          
           
            <li class="item pt-2 pb-2 md:p-2">
              <a class="item-link no-underline" href="/tests/">
                Tests
              </a>
            </li>
          
          
           
            <li class="item pt-2 pb-2 md:p-2">
              <a class="item-link no-underline" href="/calendar">
                Conferences
              </a>
            </li>
          
          
        </ul>
      </nav>

      <div class="w-full flex items-center h-12 pl-2 bg-white md:hidden">
        <svg id="menu" class="cursor-pointer w-10 h-10 p-2 text-marabesi-pink fill-current" xmlns="http://www.w3.org/2000/svg"
          x="0px" y="0px" width="50" height="50" viewBox="0 0 24 24">
          <path
            style="line-height:normal;text-indent:0;text-align:start;text-decoration-line:none;text-decoration-style:solid;text-decoration-color:#000;text-transform:none;block-progression:tb;isolation:auto;mix-blend-mode:normal"
            d="M 2 5 L 2 7 L 22 7 L 22 5 L 2 5 z M 2 11 L 2 13 L 22 13 L 22 11 L 2 11 z M 2 17 L 2 19 L 22 19 L 22 17 L 2 17 z"
            font-weight="400" font-family="sans-serif" white-space="normal" overflow="visible"></path>
        </svg>
      </div>
    </div>

    <div class="flex flex-col items-center justify-center p-5">
      <input type="text" id="search-input" placeholder="search" aria-label="search" class="focus:outline-none border border-marabesi-purple text-marabesi-purple w-full p-3 mb-2 container mt-20 lg:mt-12">
      <ul id="results-container"></ul>
    </div>

    <div class="shell-content">
      <div class="banner-highlight">
        <p class="font-normal text-lg py-4 md:text-3xl lg:text-4xl">
          <span class="apostrophe">‘‘</span>
          Code should be easy to understand.
          <span class="apostrophe">’’</span>
        </p>
        <p class="author text-xs">Dustin Boswell and Trevor Foucher - The Art Of Readable Code</p>
      </div>

        <div class="page-content container flex flex-col p-5 m-auto">
  <h1>Raspberry Pi + PHP socket</h1>

  <main class="mb-5">
    <p>Recently I did a post about <a href="/php/2015/03/22/websocket-html5.html">HTML5 WebSockets</a>
and it had a purpose. I was preparing the material of my
<a href="http://www.meetup.com/THT-Things-Hacker-Team/events/221699738" target="_blank">talk at Samsung Ocean</a> and my goal was create a RC car
with an Hybrid application to control it and not use java as a server-side language.</p>

<p>The final result you can check on my <a href="https://github.com/marabesi/brasilino4" target="_blank">github</a> and play around with the code.
The following steps are to getting the socket working in your raspberry, here I’m going to use 
the <a href="https://www.raspberrypi.org/products/model-b-plus" target="_blank">model B+</a>.</p>

<h2 id="first-of-all">First of all</h2>

<p>We need to to access our Pi trough the SSH, for this example I’m going to use the WiPi
(wireless adapter for raspberry Pi).</p>

<p><a href="/images/posts/2015-05-09-raspberry-pi-php-socket/wipidongle.jpg" target="_blank"><img src="/images/posts/2015-05-09-raspberry-pi-php-socket/wipidongle.jpg" alt="WiPi" /></a></p>

<p>But you can use the RJ-45 to access it or use a little monitor with a keyboard on the Pi, fell free to choose your
option just make sure you will have this access.
obs: In this tutorial I don’t cover how to set up wireless on your pi, refer to
<a href="https://www.raspberrypi.org/documentation/configuration/wireless/wireless-cli.md" target="_blank">wireless documentation</a>
to get it done.</p>

<h2 id="getting-started"> Getting started</h2>

<p>For this example we are going to use only the php without any web server, it is interesting isn’t it? Let’s update our Pi and install the php</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>rpi-update
</code></pre></div></div>

<p>After a few minutes the pi will be up to date and then we can finally install PHP</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>php5
</code></pre></div></div>

<h2 id="setting-up-the-socket"> Setting up the socket</h2>

<p>Choose a directory and create a <strong>socket.php</strong> file with the content below,
I’m going to use my own directory called <strong>/home/marabesi</strong></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="nv">$host</span> <span class="o">=</span> <span class="s1">'localhost'</span><span class="p">;</span>
<span class="nv">$port</span> <span class="o">=</span> <span class="s1">'9002'</span><span class="p">;</span>
<span class="nv">$null</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">;</span>

<span class="nv">$socket</span> <span class="o">=</span> <span class="nb">socket_create</span><span class="p">(</span><span class="no">AF_INET</span><span class="p">,</span> <span class="no">SOCK_STREAM</span><span class="p">,</span> <span class="no">SOL_TCP</span><span class="p">);</span>

<span class="nb">socket_set_option</span><span class="p">(</span><span class="nv">$socket</span><span class="p">,</span> <span class="no">SOL_SOCKET</span><span class="p">,</span> <span class="no">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="nb">socket_bind</span><span class="p">(</span><span class="nv">$socket</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$port</span><span class="p">);</span>

<span class="nb">socket_listen</span><span class="p">(</span><span class="nv">$socket</span><span class="p">);</span>

<span class="nv">$clients</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$socket</span><span class="p">);</span>

<span class="k">echo</span> <span class="s1">'Socket listening on host: '</span> <span class="mf">.</span> <span class="nv">$host</span> <span class="mf">.</span> <span class="s1">' port: '</span> <span class="mf">.</span> <span class="nv">$port</span> <span class="mf">.</span> <span class="kc">PHP_EOL</span><span class="p">;</span>

<span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="p">{</span>
	<span class="nv">$changed</span> <span class="o">=</span> <span class="nv">$clients</span><span class="p">;</span>

	<span class="nb">socket_select</span><span class="p">(</span><span class="nv">$changed</span><span class="p">,</span> <span class="nv">$null</span><span class="p">,</span> <span class="nv">$null</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$socket</span><span class="p">,</span> <span class="nv">$changed</span><span class="p">))</span>
    <span class="p">{</span>
		<span class="nv">$socket_new</span> <span class="o">=</span> <span class="nb">socket_accept</span><span class="p">(</span><span class="nv">$socket</span><span class="p">);</span>
		<span class="nv">$clients</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$socket_new</span><span class="p">;</span>

		<span class="nv">$header</span> <span class="o">=</span> <span class="nb">socket_read</span><span class="p">(</span><span class="nv">$socket_new</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
		<span class="nf">perform_handshaking</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="nv">$socket_new</span><span class="p">,</span> <span class="nv">$host</span><span class="p">,</span> <span class="nv">$port</span><span class="p">);</span>

		<span class="nb">socket_getpeername</span><span class="p">(</span><span class="nv">$socket_new</span><span class="p">,</span> <span class="nv">$ip</span><span class="p">);</span>
		<span class="nv">$response</span> <span class="o">=</span> <span class="nf">mask</span><span class="p">(</span><span class="nb">json_encode</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'server'</span> <span class="o">=&gt;</span> <span class="nv">$ip</span> <span class="mf">.</span> <span class="s1">' connected'</span><span class="p">)));</span>
		<span class="nf">send_message</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>

		<span class="nv">$found_socket</span> <span class="o">=</span> <span class="nb">array_search</span><span class="p">(</span><span class="nv">$socket</span><span class="p">,</span> <span class="nv">$changed</span><span class="p">);</span>
		<span class="nb">unset</span><span class="p">(</span><span class="nv">$changed</span><span class="p">[</span><span class="nv">$found_socket</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">foreach</span> <span class="p">(</span><span class="nv">$changed</span> <span class="k">as</span> <span class="nv">$changed_socket</span><span class="p">)</span>
    <span class="p">{</span>
		<span class="k">while</span><span class="p">(</span><span class="nb">socket_recv</span><span class="p">(</span><span class="nv">$changed_socket</span><span class="p">,</span> <span class="nv">$buf</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="nv">$received_text</span> <span class="o">=</span> <span class="nf">unmask</span><span class="p">(</span><span class="nv">$buf</span><span class="p">);</span>
			<span class="nv">$jsonObject</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$received_text</span><span class="p">);</span>

                        <span class="nv">$createResponse</span> <span class="o">=</span> <span class="nb">json_encode</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'server'</span> <span class="o">=&gt;</span> <span class="nv">$ip</span> <span class="mf">.</span> <span class="s1">' : '</span> <span class="mf">.</span> <span class="nb">utf8_encode</span><span class="p">(</span><span class="nv">$received_text</span><span class="p">)));</span>

                        <span class="k">echo</span> <span class="nv">$received_text</span> <span class="mf">.</span> <span class="kc">PHP_EOL</span><span class="p">;</span>

			<span class="nv">$response_text</span> <span class="o">=</span> <span class="nf">mask</span><span class="p">(</span><span class="nv">$createResponse</span><span class="p">);</span>
			<span class="nf">send_message</span><span class="p">(</span><span class="nv">$response_text</span><span class="p">);</span>

			<span class="k">break</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="nv">$buf</span> <span class="o">=</span> <span class="o">@</span><span class="nb">socket_read</span><span class="p">(</span><span class="nv">$changed_socket</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="kc">PHP_NORMAL_READ</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="nv">$buf</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span>
        <span class="p">{</span>
			<span class="nv">$found_socket</span> <span class="o">=</span> <span class="nb">array_search</span><span class="p">(</span><span class="nv">$changed_socket</span><span class="p">,</span> <span class="nv">$clients</span><span class="p">);</span>
			<span class="nb">socket_getpeername</span><span class="p">(</span><span class="nv">$changed_socket</span><span class="p">,</span> <span class="nv">$ip</span><span class="p">);</span>
			<span class="nb">unset</span><span class="p">(</span><span class="nv">$clients</span><span class="p">[</span><span class="nv">$found_socket</span><span class="p">]);</span>

			<span class="nv">$response</span> <span class="o">=</span> <span class="nf">mask</span><span class="p">(</span><span class="nb">json_encode</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'server'</span> <span class="o">=&gt;</span> <span class="nv">$ip</span> <span class="mf">.</span> <span class="s1">' disconnected'</span><span class="p">)));</span>
			<span class="nf">send_message</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="nb">socket_close</span><span class="p">(</span><span class="nv">$sock</span><span class="p">);</span>

<span class="k">function</span> <span class="n">send_message</span><span class="p">(</span><span class="nv">$msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">global</span> <span class="nv">$clients</span><span class="p">;</span>
	<span class="k">foreach</span><span class="p">(</span><span class="nv">$clients</span> <span class="k">as</span> <span class="nv">$changed_socket</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="o">@</span><span class="nb">socket_write</span><span class="p">(</span><span class="nv">$changed_socket</span><span class="p">,</span><span class="nv">$msg</span><span class="p">,</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$msg</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="n">unmask</span><span class="p">(</span><span class="nv">$text</span><span class="p">)</span>
<span class="p">{</span>
	<span class="nv">$length</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="nv">$text</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mi">127</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="nv">$length</span> <span class="o">==</span> <span class="mi">126</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$masks</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$text</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="nv">$data</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$text</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">elseif</span><span class="p">(</span><span class="nv">$length</span> <span class="o">==</span> <span class="mi">127</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$masks</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$text</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="nv">$data</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$text</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="nv">$masks</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$text</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="nv">$data</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$text</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="nv">$text</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span> <span class="o">++</span><span class="nv">$i</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$text</span> <span class="mf">.</span><span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">^</span> <span class="nv">$masks</span><span class="p">[</span><span class="nv">$i</span><span class="o">%</span><span class="mi">4</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nv">$text</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="n">mask</span><span class="p">(</span><span class="nv">$text</span><span class="p">)</span>
<span class="p">{</span>
	<span class="nv">$b1</span> <span class="o">=</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="nv">$length</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$text</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="nv">$length</span> <span class="o">&lt;=</span> <span class="mi">125</span><span class="p">)</span>
		<span class="nv">$header</span> <span class="o">=</span> <span class="nb">pack</span><span class="p">(</span><span class="s1">'CC'</span><span class="p">,</span> <span class="nv">$b1</span><span class="p">,</span> <span class="nv">$length</span><span class="p">);</span>
	<span class="k">elseif</span><span class="p">(</span><span class="nv">$length</span> <span class="o">&gt;</span> <span class="mi">125</span> <span class="o">&amp;&amp;</span> <span class="nv">$length</span> <span class="o">&lt;</span> <span class="mi">65536</span><span class="p">)</span>
		<span class="nv">$header</span> <span class="o">=</span> <span class="nb">pack</span><span class="p">(</span><span class="s1">'CCn'</span><span class="p">,</span> <span class="nv">$b1</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="nv">$length</span><span class="p">);</span>
	<span class="k">elseif</span><span class="p">(</span><span class="nv">$length</span> <span class="o">&gt;=</span> <span class="mi">65536</span><span class="p">)</span>
		<span class="nv">$header</span> <span class="o">=</span> <span class="nb">pack</span><span class="p">(</span><span class="s1">'CCNN'</span><span class="p">,</span> <span class="nv">$b1</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="nv">$length</span><span class="p">);</span>
	<span class="k">return</span> <span class="nv">$header</span><span class="mf">.</span><span class="nv">$text</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="n">perform_handshaking</span><span class="p">(</span><span class="nv">$receved_header</span><span class="p">,</span><span class="nv">$client_conn</span><span class="p">,</span> <span class="nv">$host</span><span class="p">,</span> <span class="nv">$port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="nv">$headers</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
	<span class="nv">$lines</span> <span class="o">=</span> <span class="nb">preg_split</span><span class="p">(</span><span class="s2">"/</span><span class="se">\r\n</span><span class="s2">/"</span><span class="p">,</span> <span class="nv">$receved_header</span><span class="p">);</span>
	<span class="k">foreach</span><span class="p">(</span><span class="nv">$lines</span> <span class="k">as</span> <span class="nv">$line</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="nv">$line</span> <span class="o">=</span> <span class="nb">chop</span><span class="p">(</span><span class="nv">$line</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/\A(\S+): (.*)\z/'</span><span class="p">,</span> <span class="nv">$line</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="nv">$headers</span><span class="p">[</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="nv">$matches</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="nv">$secKey</span> <span class="o">=</span> <span class="nv">$headers</span><span class="p">[</span><span class="s1">'Sec-WebSocket-Key'</span><span class="p">];</span>
	<span class="nv">$secAccept</span> <span class="o">=</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nb">pack</span><span class="p">(</span><span class="s1">'H*'</span><span class="p">,</span> <span class="nb">sha1</span><span class="p">(</span><span class="nv">$secKey</span> <span class="mf">.</span> <span class="s1">'258EAFA5-E914-47DA-95CA-C5AB0DC85B11'</span><span class="p">)));</span>
	<span class="nv">$upgrade</span>  <span class="o">=</span> <span class="s2">"HTTP/1.1 101 Web Socket Protocol Handshake</span><span class="se">\r\n</span><span class="s2">"</span> <span class="mf">.</span>
	<span class="s2">"Upgrade: websocket</span><span class="se">\r\n</span><span class="s2">"</span> <span class="mf">.</span>
	<span class="s2">"Connection: Upgrade</span><span class="se">\r\n</span><span class="s2">"</span> <span class="mf">.</span>
	<span class="s2">"WebSocket-Origin: </span><span class="nv">$host</span><span class="se">\r\n</span><span class="s2">"</span> <span class="mf">.</span>
	<span class="s2">"WebSocket-Location: ws://</span><span class="nv">$host</span><span class="s2">:</span><span class="nv">$port</span><span class="s2">/demo/shout.php</span><span class="se">\r\n</span><span class="s2">"</span><span class="mf">.</span>
	<span class="s2">"Sec-WebSocket-Accept:</span><span class="nv">$secAccept</span><span class="se">\r\n\r\n</span><span class="s2">"</span><span class="p">;</span>
	<span class="nb">socket_write</span><span class="p">(</span><span class="nv">$client_conn</span><span class="p">,</span><span class="nv">$upgrade</span><span class="p">,</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$upgrade</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now we have to create a simple HTML file to interact with our socket and see it
working, from now on we have two path to take the first is to create an HTML
file on the Pi and then access it, and the second is to create a simple HTML
in our own PC and just make the connection to our socket into the Pi.</p>

<p>Just make sure you execute the <strong>socket.php</strong> file in the Pi to be able to
listen on port 9000</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php /home/marabesi/socket.php
</code></pre></div></div>

<p>If everything goes well you’ll see the following message</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Socket listening on host: localhost port: 9000
</code></pre></div></div>

<p>IMPORTANT : You must keep the <strong>socket.php</strong> executing otherwise it won’t let
you connect through the socket. To simplify this post I’m going to go with the
second option, but you can install a web server such as nginx in your pi and
try it yourself!</p>

<p>As a alternative you can use the <a href="https://github.com/ratchetphp/Ratchet" target="_blank">Ratchet</a>
to create you socket in a much easier way and with a amazing use of
Object Oriented Programming you should check it out.</p>

<h2 id="creating-the-html-page-to-interact-with">Creating the HTML page to interact with</h2>

<p>Now we can save the following code in a file called <strong>index.html</strong></p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;title&gt;</span>WebSocket - Raspberry Pi<span class="nt">&lt;/title&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        ## Test your websocket connection!
        <span class="nt">&lt;h3&gt;</span>Just type and press enter ;)<span class="nt">&lt;/h3&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"container"</span><span class="nt">&gt;&lt;/div&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">placeholder=</span><span class="s">"Write your message to the WebSocket!"</span> <span class="na">id=</span><span class="s">"message"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;script&gt;</span>
            <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">ws://raspberryIp:raspberryPort</span><span class="dl">'</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">mySocket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">container</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">container</span><span class="dl">'</span><span class="p">);</span>

                <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">onkeypress</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">event</span> <span class="o">=</span> <span class="nx">event</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">event</span><span class="p">;</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">which</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">);</span>

                        <span class="nx">container</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">+=</span> <span class="dl">'</span><span class="s1">&lt;div&gt;&lt;span&gt;Me :&lt;/span&gt;&lt;span&gt;</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">message</span><span class="p">.</span><span class="nx">value</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">&lt;/span&gt;&lt;/div&gt;</span><span class="dl">'</span><span class="p">;</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">me: </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">message</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
                        <span class="nx">mySocket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
                        <span class="nx">message</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="dl">''</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="k">return</span> <span class="nx">event</span><span class="p">.</span><span class="nx">which</span><span class="p">;</span>
                <span class="p">};</span>

                <span class="nx">mySocket</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">opened !</span><span class="dl">'</span><span class="p">);</span>
                    <span class="nx">container</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">+=</span> <span class="dl">'</span><span class="s1">&lt;h2&gt;Connection established : </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">url</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">&lt;/h2&gt;</span><span class="dl">'</span><span class="p">;</span>
                <span class="p">};</span>

                <span class="nx">mySocket</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">server: </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
                    <span class="nx">container</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">+=</span> <span class="dl">'</span><span class="s1">&lt;div&gt;&lt;span&gt;Server: &lt;/span&gt;&lt;span&gt;</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">&lt;/span&gt;&lt;/div&gt;</span><span class="dl">'</span><span class="p">;</span>
                <span class="p">};</span>

                <span class="nx">mySocket</span><span class="p">.</span><span class="nx">onclose</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">closed !</span><span class="dl">'</span><span class="p">);</span>
                    <span class="nx">container</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">+=</span> <span class="dl">'</span><span class="s1">&lt;h2&gt;Connection closed&lt;/h2&gt;</span><span class="dl">'</span><span class="p">;</span>
                <span class="p">};</span>
            <span class="p">}());</span>
        <span class="nt">&lt;/script&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>Here we have to modify two thing to get the things done.</p>

<ol>
  <li>Where you see <strong>raspberryIp</strong> you should change to you raspberry IP</li>
  <li>And where you see <strong>raspberryPort</strong> you should also change to the port
where the socket is running and in this example the port is 9002</li>
</ol>

<p>The HTML code was originally made on codepen.io and you can see the working
example above, with the bootstrap style.</p>

<iframe width="300" height="300" style="width: 100%;" scrolling="no" src="//codepen.io/marabesi/embed/OPrBPO/?height=300&amp;theme-id=0&amp;default-tab=result" frameborder="no" allowtransparency="true" allowfullscreen="allowfullscreen">See the Pen <a href="http://codepen.io/marabesi/pen/OPrBPO" target="_blank">WebSocket !</a> by Matheus Marabesi (<a href="http://codepen.io/marabesi">@marabesi</a>) on <a href="http://codepen.io" target="_blank">CodePen</a>.<br />
</iframe>

<p>Suggestions? please let me know!</p>

<h2 id="edit-17032016---setting-up-apache-virtual-host">Edit: 17/03/2016 - Setting up Apache virtual host</h2>

<p>If you don’t have apache installed just type</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>apache2
</code></pre></div></div>

<p>You can install it on raspberry pi or anywhere you want to.
After that we need create a virtual host.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">touch</span> /etc/apache2/sites-available/websocket.conf
</code></pre></div></div>

<p>and with the file created just copy and paste the following code</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="nl">VirtualHost</span><span class="sr"> *:80</span><span class="p">&gt;
</span>        <span class="nc">ServerName</span> websocket

        <span class="nc">DocumentRoot</span> /var/www/websocket

        <span class="nc">ErrorLog</span> ${APACHE_LOG_DIR}/error.log
        <span class="nc">CustomLog</span> ${APACHE_LOG_DIR}/access.log combined
<span class="p">&lt;/</span><span class="nl">VirtualHost</span><span class="p">&gt;
</span></code></pre></div></div>

<p>As you can see our root directory is <strong>/var/www/websocket</strong> and is the place
where you should save the HTML we created to manipulate our socket connection.</p>

  </main>

  

<style>
#share-buttons {display: flex; justify-content: center; align-items: center;}
#share-buttons > div {
    position: relative;
    text-align: left; 
    height: 36px; 
    width: 32px; 
    float: left; 
    text-align: center;
}
#share-buttons > div > svg {height: 16px; fill: #f12f46; margin-top: 10px;}
#share-buttons > div:hover {cursor: pointer;}
#share-buttons > div.facebook:hover > svg {fill: #3B5998;}
#share-buttons > div.twitter:hover > svg {fill: #55ACEE;}
#share-buttons > div.linkedin:hover > svg {fill: #0077b5;}
#share-buttons > div.pinterest:hover > svg {fill: #CB2027;}
#share-buttons > div.gplus:hover > svg {fill: #dd4b39;}
#share-buttons > div.mail:hover > svg {fill: #7D7D7D;}
#share-buttons > div.instagram:hover > svg {fill: #C73B92;}
#share-buttons > div.facebook > svg {height: 18px; margin-top: 9px;}
#share-buttons > div.twitter > svg {height: 20px; margin-top: 8px;}
#share-buttons > div.linkedin > svg {height: 19px; margin-top: 7px;}
#share-buttons > div.pinterest > svg {height: 20px; margin-top: 9px;}
#share-buttons > div.gplus > svg {height: 17px; margin-top: 9px; position: relative; left: 1px;}
#share-buttons > div.mail > svg {height: 14px; margin-top: 11px;}
</style>

<div id="share-buttons" class="mb-5">
    <span>Share this on</span>
    <div class="facebook" title="Share this on Facebook" onclick="window.open('http://www.facebook.com/share.php?u=https://marabesi.com/iot/2015/05/09/raspberry-pi-php-socket.html');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759h-306v-759h-255v-296h255v-218q0-186 104-288.5t277-102.5q147 0 228 12z"/></svg></div>
    <div class="twitter" title="Share this on Twitter" onclick="window.open('https://twitter.com/intent/tweet?text=https://marabesi.com/iot/2015/05/09/raspberry-pi-php-socket.html');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg></div>
    <div class="linkedin" title="Share this on Linkedin" onclick="window.open('https://www.linkedin.com/shareArticle?mini=true&url=https://marabesi.com/iot/2015/05/09/raspberry-pi-php-socket.html&title=&summary=&source=');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg></div>
</div>

  <div id="disqus_thread"></div>
</div>


      <div class="footer">
        <div class="footer-details">
          Designed by @tamyitokazo
        </div>
      </div>
    </div>

    
    <script>
      (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
          (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date(); a = s.createElement(o),
          m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
      })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

      ga('create', 'UA-58623708-1', 'auto');
      ga('send', 'pageview');
    </script>
    

    <script async src="/assets/main-bundle.js"></script>
  </body>
</html>