<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

    <title>WebSocket - HTML5</title>
    <meta name="description"
      content="HTML5 brings a lot of new features came to help developers to createamazing apps and amazing user experience, one of these features is called websocket which...">

    <link rel="canonical" href="https://marabesi.com/php/2015/03/22/websocket-html5.html">
    <link rel="alternate" type="application/rss+xml" title="Marabesi"
      href="https://marabesi.com/feed.xml">

    <meta property="og:title" content="WebSocket - HTML5" />
    <meta property="og:site_name" content="marabesi.com" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://marabesi.com/php/2015/03/22/websocket-html5.html" />
    <meta property="og:image"
      content="https://marabesi.com/images/posts/2015-03-22-websocket-html5/cover.jpg" />
    <meta property="og:description"
      content="HTML5 brings a lot of new features came to help developers to createamazing apps and amazing user experience, one of these features is called websocket which..." />

    <meta property="fb:app_id" content="536384943068161" />

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@MatheusMarabesi">
    <meta name="twitter:title" content="WebSocket - HTML5">
    <meta name="twitter:description"
      content="HTML5 brings a lot of new features came to help developers to createamazing apps and amazing user experience, one of these features is called websocket which...">
    <meta name="twitter:creator" content="@MatheusMarabesi">
    <meta name="twitter:image:src"
      content="https://marabesi.com/images/posts/2015-03-22-websocket-html5/cover.jpg">

    <meta name="keywords" content="code pen,html5,http,php,rfc6455,slideshare,web sockets" />

    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">

    <link href="/assets/main-bundle.css" rel="stylesheet" />

    <!-- See https://goo.gl/OOhYW5 -->
    <link rel="manifest" href="/manifest.json">

    <!-- See https://goo.gl/qRE0vM -->
    <meta name="theme-color" content="#3f51b5">

    <!-- Add to homescreen for Chrome on Android. Fallback for manifest.json -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Marabesi">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Marabesi">

    <!-- Homescreen icons -->
    <link rel="apple-touch-icon" href="/images/manifest/icon-48x48.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/images/manifest/icon-72x72.png">
    <link rel="apple-touch-icon" sizes="96x96" href="/images/manifest/icon-96x96.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/images/manifest/icon-144x144.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/images/manifest/icon-192x192.png">

    <!-- Tile icon for Windows 8 (144x144 + tile color) -->
    <meta name="msapplication-TileImage" content="/images/manifest/icon-144x144.png">
    <meta name="msapplication-TileColor" content="#3f51b5">
    <meta name="msapplication-tap-highlight" content="no">
  </head>

  <body class="font-sans overflow-x-hidden">
    <button class="update-button w-full text-white bg-marabesi-purple p-5 m-auto fixed pin-b z-50 hidden focus:outline-none font-bold">Update found, click to update</button>

    <div class="menu-wrapper flex fixed w-full bg-white z-50">
      <nav class="top-menu hidden md:flex justify-start container lg:justify-center md:m-auto md:pt-2 md:pb-2">
        <a href="/" class="hidden md:block">
          <img class="logo w-18 p-1" data-src="/images/logo.png" width="100" alt="marabesi.com logo - two m's and one dot" title="marabesi.com logo - two m's and one dot" />
        </a>

        <ul id="menu-list" class="container-menu hidden flex-col pl-5 md:flex md:pl-0 md:flex-row md:m-auto lg:m-0">
          
           
            <li class="item pt-2 pb-2 md:p-2">
              <a class="item-link no-underline" href="/talks">
                Talks
              </a>
            </li>
          
          
           
            <li class="item pt-2 pb-2 md:p-2">
              <a class="item-link no-underline" href="/about">
                About
              </a>
            </li>
          
          
           
            <li class="item pt-2 pb-2 md:p-2">
              <a class="item-link no-underline" href="/newbie-guide">
                Dev guide
              </a>
            </li>
          
          
           
            <li class="item pt-2 pb-2 md:p-2">
              <a class="item-link no-underline" href="/resources">
                software development
              </a>
            </li>
          
          
           
            <li class="item pt-2 pb-2 md:p-2">
              <a class="item-link no-underline" href="/tests/">
                Tests
              </a>
            </li>
          
          
           
            <li class="item pt-2 pb-2 md:p-2">
              <a class="item-link no-underline" href="/calendar">
                Conferences
              </a>
            </li>
          
          
        </ul>
      </nav>

      <div class="w-full flex items-center h-12 pl-2 bg-white md:hidden">
        <svg id="menu" class="cursor-pointer w-10 h-10 p-2 text-marabesi-pink fill-current" xmlns="http://www.w3.org/2000/svg"
          x="0px" y="0px" width="50" height="50" viewBox="0 0 24 24">
          <path
            style="line-height:normal;text-indent:0;text-align:start;text-decoration-line:none;text-decoration-style:solid;text-decoration-color:#000;text-transform:none;block-progression:tb;isolation:auto;mix-blend-mode:normal"
            d="M 2 5 L 2 7 L 22 7 L 22 5 L 2 5 z M 2 11 L 2 13 L 22 13 L 22 11 L 2 11 z M 2 17 L 2 19 L 22 19 L 22 17 L 2 17 z"
            font-weight="400" font-family="sans-serif" white-space="normal" overflow="visible"></path>
        </svg>
      </div>
    </div>

    <div class="flex flex-col items-center justify-center p-5">
      <input type="text" id="search-input" placeholder="search" aria-label="search" class="focus:outline-none border border-marabesi-purple text-marabesi-purple w-full p-3 mb-2 container mt-20 lg:mt-12">
      <ul id="results-container"></ul>
    </div>

    <div class="shell-content">
      <div class="banner-highlight">
        <p class="font-normal text-lg py-4 md:text-3xl lg:text-4xl">
          <span class="apostrophe">‘‘</span>
          Code should be easy to understand.
          <span class="apostrophe">’’</span>
        </p>
        <p class="author text-xs">Dustin Boswell and Trevor Foucher - The Art Of Readable Code</p>
      </div>

        <div class="page-content container flex flex-col p-5 m-auto">
  <h1>WebSocket - HTML5</h1>

  <main class="mb-5">
    <p>HTML5 brings a lot of new features came to help developers to create
amazing apps and amazing user experience, one of these features is called web
socket which provides new powers under the HTTP protocol.</p>

<p>Web socket resolves the lack of HTTP when we need updating our clients with real
time data and also server events regardless of a request.</p>

<h2 id="the-client-side">The client side</h2>

<p>First of all let’s have a look in the javascript code the easiest step
to get web sockets working.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">mySocket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="dl">'</span><span class="s1">ws://myserver</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">mySocket</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>

<span class="nx">mySocket</span><span class="p">.</span><span class="nx">onclose</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>

<span class="nx">mySocket</span><span class="p">.</span><span class="nx">send</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>

<span class="nx">mySocket</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>

<span class="nx">mySocket</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>
</code></pre></div></div>

<p>With the snippet above we already have a code working but also we can specify
which protocol we want to use through or connection.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">mySocket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="dl">'</span><span class="s1">ws://myserver</span><span class="dl">'</span><span class="p">,</span> <span class="p">[</span><span class="dl">'</span><span class="s1">myProtocol</span><span class="dl">'</span><span class="p">]);</span>

<span class="nx">mySocket</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>

<span class="nx">mySocket</span><span class="p">.</span><span class="nx">onclose</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>

<span class="nx">mySocket</span><span class="p">.</span><span class="nx">send</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>

<span class="nx">mySocket</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>

<span class="nx">mySocket</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>
</code></pre></div></div>

<h2 id="handshake">Handshake</h2>
<p>Now that we have the client already is time to concentrate in a key part of the
process, the handshake. I would like to recommend if you don’t know
what is and why we must do that please see
<a href="http://en.wikipedia.org/wiki/WebSocket#WebSocket_protocol_handshake" target="_blank">this wikipedia article</a>
and <a href="https://www.websocket.org/aboutwebsocket.html" target="_blank">this from websocket.org</a>.</p>

<p>To perform a handshake we will need the client header and some hash stuff to
return those combined to upgrade our header. The key header that we are looking
for is the Sec-WebSocket-Key. So let’s to our example!</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET ws://echo.websocket.org/?encoding<span class="o">=</span>text HTTP/1.1
Origin: http://websocket.org
Cookie: <span class="nv">__utma</span><span class="o">=</span>99as
Connection: Upgrade
Host: echo.websocket.org
Sec-WebSocket-Key: uRovscZjNol/umbTt5uKmw<span class="o">==</span>
Upgrade: websocket
Sec-WebSocket-Version: 13
</code></pre></div></div>

<p>Our header value is uRovscZjNol/umbTt5uKmw== with that we will do the following
steps on our server:</p>

<ul>
  <li>Append to the uRovscZjNol/umbTt5uKmw== the value 258EAFA5-E914-47DA-95CA-C5AB0DC85B11</li>
  <li>Create a SHA1 hash with the string</li>
  <li>Apply the base64 enconding to the result of the SHA 1 encode</li>
</ul>

<p>The above steps translated to PHP code will be something like the example below</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nv">$hds</span><span class="p">;</span> <span class="c1">//headers grabed from the client header</span>

<span class="k">if</span><span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/Sec-WebSocket-Key: (.*)</span><span class="se">\r\n</span><span class="s2">/"</span><span class="p">,</span><span class="nv">$hds</span><span class="p">,</span><span class="nv">$matchs</span><span class="p">)){</span> 
  <span class="nv">$key</span> <span class="o">=</span> <span class="nv">$matchs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="mf">.</span> <span class="s1">'258EAFA5-E914-47DA-95CA-C5AB0DC85B11'</span><span class="p">;</span> 
  <span class="nv">$key</span> <span class="o">=</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nb">sha1</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="kc">true</span><span class="p">));</span> 
  <span class="nv">$headers</span> <span class="o">=</span> <span class="s2">"HTTP/1.1 101 Switching Protocols</span><span class="se">\r\n</span><span class="s2">"</span><span class="mf">.</span> 
             <span class="s2">"Upgrade: websocket</span><span class="se">\r\n</span><span class="s2">"</span><span class="mf">.</span> 
             <span class="s2">"Connection: Upgrade</span><span class="se">\r\n</span><span class="s2">"</span><span class="mf">.</span> 
             <span class="s2">"Sec-WebSocket-Accept: "</span> <span class="mf">.</span> <span class="nv">$key</span> <span class="mf">.</span> <span class="s2">"</span><span class="se">\r\n\r\n</span><span class="s2">"</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To deeper information go ahead and see the
<a href="https://tools.ietf.org/html/rfc6455" target="_blank">RFC 6455 documentation</a>.</p>

<h2 id="wrapping-everything-up">Wrapping everything up!</h2>

<p>As you saw on this post to create a websocket server from scratch is a tough
task, roughly we have a couple of projects that do all the hard work for us.</p>

<p>The most common in the PHP world is
<a href="https://github.com/ratchetphp/Ratchet" target="_blank">Ratchet</a>,
the documentation is awesome and the repository on github is updated frequently
I do recommend Ratchet.</p>

<h2 id="edit-mar28-2015">Edit: Mar 28, 2015</h2>

<iframe width="100%" height="355" style="border: 1px solid #CCC; border-width: 1px; margin-bottom: 5px; max-width: 100%;" src="//www.slideshare.net/slideshow/embed_code/46061464" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" allowfullscreen="allowfullscreen"> </iframe>

  </main>

  

<style>
#share-buttons {display: flex; justify-content: center; align-items: center;}
#share-buttons > div {
    position: relative;
    text-align: left; 
    height: 36px; 
    width: 32px; 
    float: left; 
    text-align: center;
}
#share-buttons > div > svg {height: 16px; fill: #f12f46; margin-top: 10px;}
#share-buttons > div:hover {cursor: pointer;}
#share-buttons > div.facebook:hover > svg {fill: #3B5998;}
#share-buttons > div.twitter:hover > svg {fill: #55ACEE;}
#share-buttons > div.linkedin:hover > svg {fill: #0077b5;}
#share-buttons > div.pinterest:hover > svg {fill: #CB2027;}
#share-buttons > div.gplus:hover > svg {fill: #dd4b39;}
#share-buttons > div.mail:hover > svg {fill: #7D7D7D;}
#share-buttons > div.instagram:hover > svg {fill: #C73B92;}
#share-buttons > div.facebook > svg {height: 18px; margin-top: 9px;}
#share-buttons > div.twitter > svg {height: 20px; margin-top: 8px;}
#share-buttons > div.linkedin > svg {height: 19px; margin-top: 7px;}
#share-buttons > div.pinterest > svg {height: 20px; margin-top: 9px;}
#share-buttons > div.gplus > svg {height: 17px; margin-top: 9px; position: relative; left: 1px;}
#share-buttons > div.mail > svg {height: 14px; margin-top: 11px;}
</style>

<div id="share-buttons" class="mb-5">
    <span>Share this on</span>
    <div class="facebook" title="Share this on Facebook" onclick="window.open('http://www.facebook.com/share.php?u=https://marabesi.com/php/2015/03/22/websocket-html5.html');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759h-306v-759h-255v-296h255v-218q0-186 104-288.5t277-102.5q147 0 228 12z"/></svg></div>
    <div class="twitter" title="Share this on Twitter" onclick="window.open('https://twitter.com/intent/tweet?text=https://marabesi.com/php/2015/03/22/websocket-html5.html');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg></div>
    <div class="linkedin" title="Share this on Linkedin" onclick="window.open('https://www.linkedin.com/shareArticle?mini=true&url=https://marabesi.com/php/2015/03/22/websocket-html5.html&title=&summary=&source=');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg></div>
</div>

  <div id="disqus_thread"></div>
</div>


      <div class="footer">
        <div class="footer-details">
          Designed by @tamyitokazo
        </div>
      </div>
    </div>

    
    <script>
      (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
          (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date(); a = s.createElement(o),
          m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
      })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

      ga('create', 'UA-58623708-1', 'auto');
      ga('send', 'pageview');
    </script>
    

    <script async src="/assets/main-bundle.js"></script>
  </body>
</html>