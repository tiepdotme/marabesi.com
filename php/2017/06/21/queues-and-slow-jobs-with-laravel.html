<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

    <title>Queues and slow jobs with Laravel</title>
    <meta name="description"
      content="Queues are commonly used on a daily basis of software development, even the IoT worldhas an specific protocol that implements this concept. Laravel doesthe s...">

    <link rel="canonical" href="https://marabesi.com/php/2017/06/21/queues-and-slow-jobs-with-laravel.html">
    <link rel="alternate" type="application/rss+xml" title="Marabesi"
      href="https://marabesi.com/feed.xml">

    <meta property="og:title" content="Queues and slow jobs with Laravel" />
    <meta property="og:site_name" content="marabesi.com" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://marabesi.com/php/2017/06/21/queues-and-slow-jobs-with-laravel.html" />
    <meta property="og:image"
      content="https://marabesi.com/images/posts/2017-06-21-queues-and-slow-jobs-with-laravel/cover.png" />
    <meta property="og:description"
      content="Queues are commonly used on a daily basis of software development, even the IoT worldhas an specific protocol that implements this concept. Laravel doesthe s..." />

    <meta property="fb:app_id" content="536384943068161" />

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@MatheusMarabesi">
    <meta name="twitter:title" content="Queues and slow jobs with Laravel">
    <meta name="twitter:description"
      content="Queues are commonly used on a daily basis of software development, even the IoT worldhas an specific protocol that implements this concept. Laravel doesthe s...">
    <meta name="twitter:creator" content="@MatheusMarabesi">
    <meta name="twitter:image:src"
      content="https://marabesi.com/images/posts/2017-06-21-queues-and-slow-jobs-with-laravel/cover.png">

    <meta name="keywords" content="queue,Laravel,database,default,email,table,send,file,sync,jobs,failed,configuration,Queues,queues,laravel,quickbooks,php" />

    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">

    <link href="/assets/main-bundle.css" rel="stylesheet" />

    <!-- See https://goo.gl/OOhYW5 -->
    <link rel="manifest" href="/manifest.json">

    <!-- See https://goo.gl/qRE0vM -->
    <meta name="theme-color" content="#3f51b5">

    <!-- Add to homescreen for Chrome on Android. Fallback for manifest.json -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Marabesi">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Marabesi">

    <!-- Homescreen icons -->
    <link rel="apple-touch-icon" href="/images/manifest/icon-48x48.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/images/manifest/icon-72x72.png">
    <link rel="apple-touch-icon" sizes="96x96" href="/images/manifest/icon-96x96.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/images/manifest/icon-144x144.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/images/manifest/icon-192x192.png">

    <!-- Tile icon for Windows 8 (144x144 + tile color) -->
    <meta name="msapplication-TileImage" content="/images/manifest/icon-144x144.png">
    <meta name="msapplication-TileColor" content="#3f51b5">
    <meta name="msapplication-tap-highlight" content="no">
  </head>

  <body class="font-sans overflow-x-hidden">
    <button class="update-button w-full text-white bg-marabesi-purple p-5 m-auto fixed pin-b z-50 hidden focus:outline-none font-bold">Update found, click to update</button>

    <div class="menu-wrapper flex fixed w-full bg-white z-50">
      <nav class="top-menu hidden md:flex justify-start container lg:justify-center md:m-auto md:pt-2 md:pb-2">
        <a href="/" class="hidden md:block">
          <img class="logo w-18 p-1" data-src="/images/logo.png" width="100" alt="marabesi.com logo - two m's and one dot" title="marabesi.com logo - two m's and one dot" />
        </a>

        <ul id="menu-list" class="container-menu hidden flex-col pl-5 md:flex md:pl-0 md:flex-row md:m-auto lg:m-0">
          
           
            <li class="item pt-2 pb-2 md:p-2">
              <a class="item-link no-underline" href="/talks">
                Talks
              </a>
            </li>
          
          
           
            <li class="item pt-2 pb-2 md:p-2">
              <a class="item-link no-underline" href="/about">
                About
              </a>
            </li>
          
          
           
            <li class="item pt-2 pb-2 md:p-2">
              <a class="item-link no-underline" href="/newbie-guide">
                Dev guide
              </a>
            </li>
          
          
           
            <li class="item pt-2 pb-2 md:p-2">
              <a class="item-link no-underline" href="/resources">
                software development
              </a>
            </li>
          
          
           
            <li class="item pt-2 pb-2 md:p-2">
              <a class="item-link no-underline" href="/tests/">
                Tests
              </a>
            </li>
          
          
           
            <li class="item pt-2 pb-2 md:p-2">
              <a class="item-link no-underline" href="/calendar">
                Conferences
              </a>
            </li>
          
          
        </ul>
      </nav>

      <div class="w-full flex items-center h-12 pl-2 bg-white md:hidden">
        <svg id="menu" class="cursor-pointer w-10 h-10 p-2 text-marabesi-pink fill-current" xmlns="http://www.w3.org/2000/svg"
          x="0px" y="0px" width="50" height="50" viewBox="0 0 24 24">
          <path
            style="line-height:normal;text-indent:0;text-align:start;text-decoration-line:none;text-decoration-style:solid;text-decoration-color:#000;text-transform:none;block-progression:tb;isolation:auto;mix-blend-mode:normal"
            d="M 2 5 L 2 7 L 22 7 L 22 5 L 2 5 z M 2 11 L 2 13 L 22 13 L 22 11 L 2 11 z M 2 17 L 2 19 L 22 19 L 22 17 L 2 17 z"
            font-weight="400" font-family="sans-serif" white-space="normal" overflow="visible"></path>
        </svg>
      </div>
    </div>

    <div class="flex flex-col items-center justify-center p-5">
      <input type="text" id="search-input" placeholder="search" aria-label="search" class="focus:outline-none border border-marabesi-purple text-marabesi-purple w-full p-3 mb-2 container mt-20 lg:mt-12">
      <ul id="results-container"></ul>
    </div>

    <div class="shell-content">
      <div class="banner-highlight">
        <p class="font-normal text-lg py-4 md:text-3xl lg:text-4xl">
          <span class="apostrophe">‘‘</span>
          Code should be easy to understand.
          <span class="apostrophe">’’</span>
        </p>
        <p class="author text-xs">Dustin Boswell and Trevor Foucher - The Art Of Readable Code</p>
      </div>

        <div class="page-content container flex flex-col p-5 m-auto">
  <h1>Queues and slow jobs with Laravel</h1>

  <main class="mb-5">
    <p>Queues are commonly used on a daily basis of software development, even the IoT world
has an specific protocol that implements this concept. Laravel does
the same providing developers with an amazing API.</p>

<p>Here, we are going to focus on the theory and practice itself being
independent of any vendor such as Amazon or Beanstalkd, for that
you can check <a href="https://laravel.com/docs/queues" target="_blank">Laravel’s documentation</a>.</p>

<h2 id="basics">Basics</h2>

<p>The first thing to notice is how Laravel handles the configuration part,
as usual the configuration part is in the <strong>config</strong> folder, the file queue.php
is the place to set up the details of our service.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">return</span> <span class="p">[</span>

    <span class="cm">/*
    |--------------------------------------------------------------------------
    | Default Queue Driver
    |--------------------------------------------------------------------------
    |
    | Laravel's queue API supports an assortment of back-ends via a single
    | API, giving you convenient access to each back-end using the same
    | syntax for each one. Here you may set the default queue driver.
    |
    | Supported: "sync", "database", "beanstalkd", "sqs", "redis", "null"
    |
    */</span>

    <span class="s1">'default'</span> <span class="o">=&gt;</span> <span class="nf">env</span><span class="p">(</span><span class="s1">'QUEUE_DRIVER'</span><span class="p">,</span> <span class="s1">'sync'</span><span class="p">),</span>

    <span class="cm">/*
    |--------------------------------------------------------------------------
    | Queue Connections
    |--------------------------------------------------------------------------
    |
    | Here you may configure the connection information for each server that
    | is used by your application. A default configuration has been added
    | for each back-end shipped with Laravel. You are free to add more.
    |
    */</span>

    <span class="s1">'connections'</span> <span class="o">=&gt;</span> <span class="p">[</span>

        <span class="s1">'sync'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'driver'</span> <span class="o">=&gt;</span> <span class="s1">'sync'</span><span class="p">,</span>
        <span class="p">],</span>

        <span class="s1">'database'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'driver'</span> <span class="o">=&gt;</span> <span class="s1">'database'</span><span class="p">,</span>
            <span class="s1">'table'</span> <span class="o">=&gt;</span> <span class="s1">'jobs'</span><span class="p">,</span>
            <span class="s1">'queue'</span> <span class="o">=&gt;</span> <span class="s1">'default'</span><span class="p">,</span>
            <span class="s1">'retry_after'</span> <span class="o">=&gt;</span> <span class="mi">90</span><span class="p">,</span>
        <span class="p">],</span>

        <span class="s1">'beanstalkd'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'driver'</span> <span class="o">=&gt;</span> <span class="s1">'beanstalkd'</span><span class="p">,</span>
            <span class="s1">'host'</span> <span class="o">=&gt;</span> <span class="s1">'localhost'</span><span class="p">,</span>
            <span class="s1">'queue'</span> <span class="o">=&gt;</span> <span class="s1">'default'</span><span class="p">,</span>
            <span class="s1">'retry_after'</span> <span class="o">=&gt;</span> <span class="mi">90</span><span class="p">,</span>
        <span class="p">],</span>

        <span class="s1">'sqs'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'driver'</span> <span class="o">=&gt;</span> <span class="s1">'sqs'</span><span class="p">,</span>
            <span class="s1">'key'</span> <span class="o">=&gt;</span> <span class="s1">'your-public-key'</span><span class="p">,</span>
            <span class="s1">'secret'</span> <span class="o">=&gt;</span> <span class="s1">'your-secret-key'</span><span class="p">,</span>
            <span class="s1">'prefix'</span> <span class="o">=&gt;</span> <span class="s1">'https://sqs.us-east-1.amazonaws.com/your-account-id'</span><span class="p">,</span>
            <span class="s1">'queue'</span> <span class="o">=&gt;</span> <span class="s1">'your-queue-name'</span><span class="p">,</span>
            <span class="s1">'region'</span> <span class="o">=&gt;</span> <span class="s1">'us-east-1'</span><span class="p">,</span>
        <span class="p">],</span>

        <span class="s1">'redis'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'driver'</span> <span class="o">=&gt;</span> <span class="s1">'redis'</span><span class="p">,</span>
            <span class="s1">'connection'</span> <span class="o">=&gt;</span> <span class="s1">'default'</span><span class="p">,</span>
            <span class="s1">'queue'</span> <span class="o">=&gt;</span> <span class="s1">'default'</span><span class="p">,</span>
            <span class="s1">'retry_after'</span> <span class="o">=&gt;</span> <span class="mi">90</span><span class="p">,</span>
        <span class="p">],</span>

    <span class="p">],</span>

    <span class="cm">/*
    |--------------------------------------------------------------------------
    | Failed Queue Jobs
    |--------------------------------------------------------------------------
    |
    | These options configure the behavior of failed queue job logging so you
    | can control which database and table are used to store the jobs that
    | have failed. You may change them to any database / table you wish.
    |
    */</span>

    <span class="s1">'failed'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'database'</span> <span class="o">=&gt;</span> <span class="nf">env</span><span class="p">(</span><span class="s1">'DB_CONNECTION'</span><span class="p">,</span> <span class="s1">'mysql'</span><span class="p">),</span>
        <span class="s1">'table'</span> <span class="o">=&gt;</span> <span class="s1">'failed_jobs'</span><span class="p">,</span>
    <span class="p">],</span>

<span class="p">];</span>
</code></pre></div></div>

<p>The dotenv approach used is the best thing of it, as you could see
the configuration file is almost enteirely driven by it. sync is the default
driver to use queues, which means that Laravel won’t use any queue at all, it will
just run the code synchronously as it runs normally.</p>

<p>The first change is not in this file, it is in the .env file, created automatically 
when Laravel is installed, we are going to use the database drive.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> QUEUE_DRIVER=database
</code></pre></div></div>

<p>Cool, the next thing to do is to create the necessary tables to handle the queue.
Laravel has an Artisan helper to make it for us, when the database is properly configured,
go in your terminal and run the folowing code:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php artisan queue:table
</code></pre></div></div>

<p>The Artisan command will genenrate a migration file, which  contains the table struture,
then we need to execute the migrate command to create the table in our database</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php artisan migrate
</code></pre></div></div>

<h2 id="creating-services">Creating services</h2>

<p>The most common example is to send an email through the queue system. If you are wondering
why, the answer is simple. Queues give a friedly feedback to the user, which means that 
they will receive an answer as fast as possible while the applicationis still working in the background.</p>

<p>For this reason Laravel has a few methods that work great with sending email</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">App\Http\Controllers</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Illuminate\Http\Request</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">EmailController</span> <span class="kd">extends</span> <span class="nc">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">send</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nc">Mail</span><span class="o">::</span><span class="nf">later</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">'welcome.blade'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'data'</span> <span class="o">=&gt;</span> <span class="s1">'Email sent!'</span><span class="p">],</span> <span class="k">function</span><span class="p">(</span><span class="nv">$message</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$message</span><span class="o">-&gt;</span><span class="nf">to</span><span class="p">(</span><span class="s1">'my@email.com'</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="k">return</span> <span class="s1">'Email has been sent successfully!'</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The code above ilustrates how would it be to send an email using the queue, usually to send emails we invoke the method
<strong>send</strong>, but the Laravel documentation gives to us a good reason to queue:</p>

<p>“Since sending email messages can drastically lengthen the response time of your application, many developers choose to 
queue email messages for background sending. Laravel makes this easy using its built-in unified queue API.” - <a href="https://laravel.com/docs/5.4/mail#configuring-the-view" target="_blank">Laravel docs</a></p>

<p>If you didn’t notice, the method invoked here is the later, and its first argument is how many seconds it should be delayed.
In our case we are going to send the email after 10 seconds, but if you run this code you will immediately see the message: 
“Email has been sent successfully!”.</p>

  </main>

  

<style>
#share-buttons {display: flex; justify-content: center; align-items: center;}
#share-buttons > div {
    position: relative;
    text-align: left; 
    height: 36px; 
    width: 32px; 
    float: left; 
    text-align: center;
}
#share-buttons > div > svg {height: 16px; fill: #f12f46; margin-top: 10px;}
#share-buttons > div:hover {cursor: pointer;}
#share-buttons > div.facebook:hover > svg {fill: #3B5998;}
#share-buttons > div.twitter:hover > svg {fill: #55ACEE;}
#share-buttons > div.linkedin:hover > svg {fill: #0077b5;}
#share-buttons > div.pinterest:hover > svg {fill: #CB2027;}
#share-buttons > div.gplus:hover > svg {fill: #dd4b39;}
#share-buttons > div.mail:hover > svg {fill: #7D7D7D;}
#share-buttons > div.instagram:hover > svg {fill: #C73B92;}
#share-buttons > div.facebook > svg {height: 18px; margin-top: 9px;}
#share-buttons > div.twitter > svg {height: 20px; margin-top: 8px;}
#share-buttons > div.linkedin > svg {height: 19px; margin-top: 7px;}
#share-buttons > div.pinterest > svg {height: 20px; margin-top: 9px;}
#share-buttons > div.gplus > svg {height: 17px; margin-top: 9px; position: relative; left: 1px;}
#share-buttons > div.mail > svg {height: 14px; margin-top: 11px;}
</style>

<div id="share-buttons" class="mb-5">
    <span>Share this on</span>
    <div class="facebook" title="Share this on Facebook" onclick="window.open('http://www.facebook.com/share.php?u=https://marabesi.com/php/2017/06/21/queues-and-slow-jobs-with-laravel.html');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759h-306v-759h-255v-296h255v-218q0-186 104-288.5t277-102.5q147 0 228 12z"/></svg></div>
    <div class="twitter" title="Share this on Twitter" onclick="window.open('https://twitter.com/intent/tweet?text=https://marabesi.com/php/2017/06/21/queues-and-slow-jobs-with-laravel.html');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg></div>
    <div class="linkedin" title="Share this on Linkedin" onclick="window.open('https://www.linkedin.com/shareArticle?mini=true&url=https://marabesi.com/php/2017/06/21/queues-and-slow-jobs-with-laravel.html&title=&summary=&source=');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg></div>
</div>

  <div id="disqus_thread"></div>
</div>


      <div class="footer">
        <div class="footer-details">
          Designed by @tamyitokazo
        </div>
      </div>
    </div>

    
    <script>
      (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
          (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date(); a = s.createElement(o),
          m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
      })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

      ga('create', 'UA-58623708-1', 'auto');
      ga('send', 'pageview');
    </script>
    

    <script async src="/assets/main-bundle.js"></script>
  </body>
</html>